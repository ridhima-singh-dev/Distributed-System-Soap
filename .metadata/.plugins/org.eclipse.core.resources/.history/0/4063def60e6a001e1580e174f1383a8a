package service.broker;

import java.net.InetSocketAddress;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.concurrent.Executors;

import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpServer;

import javax.jmdns.JmDNS;
import javax.jmdns.ServiceEvent;
import javax.jmdns.ServiceListener;
import javax.xml.namespace.QName;
import javax.xml.ws.Endpoint;
import javax.xml.ws.Service;

import service.core.ClientInfo;
import service.core.Quotation;
import service.core.QuotationService;

public class BrokerMain {

	private static ClientInfo info;

	public static void main(String[] args) {

		/*List<String> quotationUrls = new ArrayList<>();

		for (String arg : args) {
			quotationUrls.add(arg);
		}*/
		LocalBrokerService localBrokerService = new LocalBrokerService();

		String host = "localhost";
		if (args.length > 0) {
			host = args[0];
		}
		 try {
	            Endpoint endpoint = Endpoint.create(new LocalBrokerService());
	            HttpServer server = HttpServer.create(new InetSocketAddress(9000), 5);
	            server.setExecutor(Executors.newFixedThreadPool(5));
	            HttpContext context = server.createContext("/broker");
	            endpoint.publish(context);
	            server.start();
	            //Create a JmDNS instance
	            JmDNS jmdns = JmDNS.create(host);
	            System.out.println("on host " + jmdns.getInetAddress());
	            // Add service listener
	            jmdns.addServiceListener("_quote._tcp.local.", new LocalBrokerService());
	            System.out.println("broker is running");
	        } catch (Exception e) {
	            e.printStackTrace();
	        }
	}
	
//	private static class WsdlServiceListener implements ServiceListener{
//
//        @Override
//        public void serviceAdded(ServiceEvent serviceEvent) {
//        }
//
//        @Override
//        public void serviceRemoved(ServiceEvent serviceEvent) {
//        }
//
//        @Override
//        public void serviceResolved(ServiceEvent event) {
//            //call add url function to add online services
//            String path=event.getInfo().getPropertyString("path");
//            try {
//            	if(path!=null) {
//					String url = event.getInfo().getURLs()[0];
//					connectToService(url);
//				}
//            }  catch (Exception e) {
//               e.printStackTrace();
//            }
//        }
//    }
//
//	protected static void connectToService(String path) {
//		// TODO Auto-generated method stub
//		LinkedList<Quotation> quotations = new LinkedList<Quotation>();
//		try {
//			URL	wsdlUrl = new URL(path);
//
//			QName serviceName = new QName("http://core.service/", "QuotationService");
//			Service service = Service.create(wsdlUrl, serviceName);
//			QName portName = new QName("http://core.service/", "QuotationServicePort");
//			QuotationService quotationService = service.getPort(portName, QuotationService.class);
//			quotations.add(quotationService.generateQuotation(info));
//		} catch (MalformedURLException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		}
//
//	}

}
